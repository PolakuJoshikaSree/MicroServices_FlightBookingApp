package com.bookingservice.service.impl;

import com.bookingservice.client.FlightClient;
import com.bookingservice.model.Booking;
import com.bookingservice.repository.BookingRepository;
import com.bookingservice.request.BookingRequest;
import com.bookingservice.service.BookingService;
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.UUID;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
public class BookingServiceImpl implements BookingService {

    private final BookingRepository repo;
    private final FlightClient flightClient; // Feign
    @Override
    @CircuitBreaker(name = "bookingCB", fallbackMethod = "bookingFallback")
    public Booking bookFlight(BookingRequest req) {

        boolean ok = flightClient.reserveSeats(req.getFlightId(), req.getSeatNumbers().size());
        if(!ok) throw new RuntimeException("Seats not available");

        Booking booking = Booking.builder()
                .pnr(UUID.randomUUID().toString().substring(0,8).toUpperCase())
                .flightId(req.getFlightId())
                .userName(req.getUserName())
                .email(req.getEmail())
                .passengers(req.getPassengers())
                .seats(req.getSeatNumbers())
                .meal(req.isMeal())
                .journeyDate(req.getJourneyDate())
                .bookingDateTime(LocalDateTime.now())
                .status("BOOKED")
                .build();

        return repo.save(booking).block();
    }

    public Booking bookingFallback(BookingRequest req, Throwable ex) {
        return null; 
    }
    @Override
    public Booking getByPnr(String pnr){
        return repo.findByPnr(pnr).block();
    }
    @Override
    public List<Booking> getHistoryByEmail(String email){
        return repo.findByEmail(email).collectList().block();
    }
    @Override
    @CircuitBreaker(name = "cancelCB", fallbackMethod = "cancelFallback")
    public String cancel(String pnr){

        Booking b = repo.findByPnr(pnr).block();
        if(b == null) return "No booking found";

        if(LocalDate.now().plusDays(1).isAfter(b.getJourneyDate()))
            return "Cannot cancel within 24 hours";

        flightClient.releaseSeats(b.getFlightId(), b.getSeats().size());

        repo.delete(b).block();
        return "Cancelled Successfully";
    }
    public String cancelFallback(String pnr, Throwable ex){
        return "Flight-Service unavailable ‚ùå Try later";
    }
}
