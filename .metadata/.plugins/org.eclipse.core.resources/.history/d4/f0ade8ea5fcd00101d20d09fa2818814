package com.bookingservice.service.impl;

import com.bookingservice.client.FlightClient;
import com.bookingservice.model.Booking;
import com.bookingservice.repository.BookingRepository;
import com.bookingservice.request.BookingRequest;
import com.bookingservice.service.BookingService;
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import lombok.RequiredArgsConstructor;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import org.springframework.stereotype.Service;

import java.util.UUID;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Service
@RequiredArgsConstructor
public class BookingServiceImpl implements BookingService {

    private final BookingRepository repo;
    private final FlightClient flightClient;

    @Override
    @CircuitBreaker(name="bookingCB", fallbackMethod="bookingFallback")
    public Mono<Booking> bookFlight(BookingRequest req) {

        return Mono.fromCallable(() -> {
            boolean ok = flightClient.reserveSeats(req.getFlightId(), req.getSeatNumbers().size());
            if (!ok) throw new RuntimeException("Seats not available");
            return ok;
        })
        .flatMap(a -> {
            Booking booking = Booking.builder()
                    .pnr(UUID.randomUUID().toString().substring(0, 8).toUpperCase())
                    .flightId(req.getFlightId())
                    .userName(req.getUserName())
                    .email(req.getEmail())
                    .seatNumbers(req.getSeatNumbers())
                    .passengers(req.getPassengers())
                    .meal(req.isMeal())
                    .journeyDate(req.getJourneyDate())
                    .bookingDateTime(LocalDateTime.now())
                    .status("BOOKED")
                    .build();

            return repo.save(booking); // ★ Now reactive save executes correctly ✔
        });
    }

    public Mono<Booking> bookingFallback(BookingRequest req, Throwable ex) {
        return Mono.empty();
    }

    @Override
    public Mono<Booking> getByPnr(String pnr){
        return repo.findByPnr(pnr);
    }

    @Override
    public Flux<Booking> getHistoryByEmail(String email){
        return repo.findByEmail(email);
    }

    @Override
    @CircuitBreaker(name="cancelCB", fallbackMethod="cancelFallback")
    public Mono<String> cancel(String pnr){

        return repo.findByPnr(pnr)
                .flatMap(b -> {

                    if(LocalDate.now().plusDays(1).isAfter(b.getJourneyDate()))
                        return Mono.just("Cannot cancel within 24 hours");

                    flightClient.releaseSeats(b.getFlightId(), b.getSeatNumbers().size());
                    return repo.delete(b).thenReturn("Cancelled Successfully");
                })
                .defaultIfEmpty("No booking found");
    }

    public Mono<String> cancelFallback(String pnr, Throwable ex){
        return Mono.just("Flight-Service unavailable, Try later");
    }
}
